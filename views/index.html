<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>后台管理系统 - 主页</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
<div class="min-h-screen">

  <!-- 顶部导航 -->
  <nav class="bg-white/80 backdrop-blur shadow-sm sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        <h1 class="text-xl font-bold text-gray-900">用户管理系统</h1>
        <div class="flex items-center space-x-4">
          <!-- 当前登录用户头像 -->
          <img id="currentUserAvatar"
               class="w-8 h-8 rounded-full object-cover cursor-pointer hover:opacity-80 hidden"
               src="" alt="头像"
               onclick="openAvatarModal(currentUserId)" title="点击更换头像">
          <button onclick="logout()" class="text-red-600 hover:text-red-700 flex items-center gap-1 text-sm">
            <i data-feather="log-out" class="w-4 h-4"></i>
            <span>退出系统</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- 主内容 -->
  <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
          <div class="flex items-center gap-3">
            <i data-feather="users" class="w-5 h-5 text-gray-500"></i>
            <h2 class="text-lg font-semibold text-gray-900">用户列表</h2>
            <span class="text-sm text-gray-500">共 <strong id="userCount" class="text-gray-900">0</strong> 条</span>
          </div>
          <button onclick="addUser()" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm hover:bg-indigo-700 transition">
            <i data-feather="plus" class="w-4 h-4"></i>
            添加用户
          </button>
        </div>

        <!-- 表格：头像列已删除 -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-100">
            <thead class="bg-gray-50/50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户名</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
            </tr>
            </thead>
            <tbody id="userTableBody" class="bg-white divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- 通用遮罩 + 弹框 -->
<div id="modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-96 p-6">
    <h3 id="modalTitle" class="text-base font-semibold mb-4"></h3>
    <form id="modalForm" onsubmit="return false;">
      <input type="hidden" id="userId">
      <div class="mb-3">
        <label class="block text-sm mb-1">用户名</label>
        <input id="username" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>
      <div class="mb-3">
        <label class="block text-sm mb-1">密码</label>
        <input type="password" id="password" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>
      <div id="roleBox" class="mb-3 hidden">
        <label class="block text-sm mb-1">角色</label>
        <select id="role" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
          <option value="1">管理员</option>
          <option value="2">普通用户</option>
        </select>
      </div>
      <div id="statusBox" class="mb-3 hidden">
        <label class="block text-sm mb-1">状态</label>
        <select id="status" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
          <option value="1">正常</option>
          <option value="0">禁用</option>
        </select>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button onclick="closeModal()" class="px-4 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-50">取消</button>
        <button onclick="submitModal()" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">确定</button>
      </div>
    </form>
  </div>
</div>

<!-- 头像专用弹窗 -->
<div id="avatarModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-80 p-6">
    <h3 class="text-base font-semibold mb-4">更换头像</h3>
    <div class="flex flex-col items-center gap-4">
      <img id="avatarPreview" class="w-24 h-24 rounded-full object-cover border border-gray-200">
      <label for="avatarFile"
             class="px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm
              hover:bg-indigo-700 cursor-pointer inline-flex items-center gap-2">
        <i data-feather="upload" class="w-4 h-4"></i>
        <span id="btnText">上传头像</span>
      </label>
      <input type="file" id="avatarFile" accept="image/*" class="hidden">
      <input type="hidden" id="avatarUserId">
      <div class="flex gap-2">
        <button onclick="closeAvatarModal()" class="px-4 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-50">取消</button>
        <button onclick="uploadAvatar()" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">上传</button>
      </div>
    </div>
  </div>
</div>

<script>
  feather.replace();

  let currentUserId = null;          // 当前登录用户ID

  /* ---------- 弹框 ---------- */
  const modal       = document.getElementById('modal');
  const modalTitle  = document.getElementById('modalTitle');
  const avatarModal = document.getElementById('avatarModal');

  function openModal(title) {
    modalTitle.textContent = title;
    modal.classList.remove('hidden');
  }
  function closeModal() {
    modal.classList.add('hidden');
    document.getElementById('modalForm').reset();
    document.getElementById('userId').value = '';
  }
  function openAvatarModal(uid) {
    avatarModal.classList.remove('hidden');
    document.getElementById('avatarUserId').value = uid;

    // 弹窗预览强制刷新
    const preview = document.getElementById('avatarPreview');
    preview.src = `/avatar/${uid}?t=${Date.now()}`;

    // 顶部头像同步（可选）
    if (uid === currentUserId) {
      const top = document.getElementById('currentUserAvatar');
      if (top) top.src = preview.src;
    }

  }
  function closeAvatarModal() {
    avatarModal.classList.add('hidden');
  }

  /* ---------- 渲染当前登录用户头像 ---------- */
  function renderCurrentUserAvatar() {
    if (!currentUserId) return;
    const img = document.getElementById('currentUserAvatar');
    if (img) {
      img.src = `/avatar/${currentUserId}?t=${Date.now()}`;
      img.classList.remove('hidden');
    }
  }

  /* ---------- 加载用户 ---------- */
  async function loadAllUsers() {
    try {
      const res  = await fetch('/users?page=1&pageSize=100');
      const json = await res.json();
      if (json.code !== 200) return;
      const users = json.data || [];
      // 约定：第一条是当前登录用户
      if (users.length > 0) currentUserId = users[0].id;

      /* 渲染列表（无头像列） */
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '';
      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition';
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${u.username ?? '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${u.role === 1 ? '管理员' : '普通用户'}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                u.status === 1 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${u.status === 1 ? '正常' : '禁用'}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${u.CreatedAt ?? '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
            <button onclick="editUser(${u.id},'${u.username}',${u.role},${u.status})" class="text-indigo-600 hover:text-indigo-800 transition">编辑</button>
            <button onclick="del(${u.id})" class="text-red-600 hover:text-red-800 transition">删除</button>
          </td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('userCount').textContent = users.length;
      renderCurrentUserAvatar();          // 顶部头像
    } catch (e) {
      console.error('加载用户列表失败:', e);
    }
  }

  /* ---------- 头像上传 ---------- */
  async function uploadAvatar() {
    const file = document.getElementById('avatarFile').files[0];
    if (!file) { alert('请先选择图片'); return; }
    const uid = document.getElementById('avatarUserId').value;
    const fd = new FormData();
    fd.append('avatar', file);
    const res = await fetch(`/avatar/${uid}/upload`, { method: 'POST', body: fd });
    const json = await res.json();
    if (json.code === 200) {
      /* 刷新当前用户头像 + 列表 */
      document.getElementById('avatarPreview').src = `/avatar/${uid}?t=${Date.now()}`;
      renderCurrentUserAvatar();   // 顶部
      loadAllUsers();
      closeAvatarModal();
    } else {
      alert('上传失败：' + json.message);
    }
  }

  /* ---------- 增删改查不变 ---------- */
  function addUser() {
    openModal('添加用户');
    document.getElementById('roleBox').classList.add('hidden');
    document.getElementById('statusBox').classList.add('hidden');
  }
  function editUser(id, username, role, status) {
    openModal('编辑用户');
    document.getElementById('userId').value = id;
    document.getElementById('username').value = username;
    document.getElementById('role').value = role;
    document.getElementById('status').value = status;
    document.getElementById('roleBox').classList.remove('hidden');
    document.getElementById('statusBox').classList.remove('hidden');
  }
  function del(id) {
    if (!confirm('确定删除该用户？')) return;
    fetch(`/user/${id}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(json => {
              if (json.code === 200) {
                alert('删除成功'); loadAllUsers();
              } else {
                alert('删除失败：' + json.message);
              }
            });
  }
  function submitModal() {
    const id = document.getElementById('userId').value;
    const url = id ? `/user/${id}` : '/user';
    const method = id ? 'PUT' : 'POST';
    const formData = new FormData();
    formData.append('username', document.getElementById('username').value.trim());
    formData.append('password', document.getElementById('password').value.trim());
    if (id) {
      formData.append('role', document.getElementById('role').value);
      formData.append('status', document.getElementById('status').value);
    }
    fetch(url, { method, body: formData })
            .then(res => res.json())
            .then(json => {
              if (json.code === 200) {
                closeModal(); loadAllUsers();
              } else {
                alert('操作失败：' + json.message);
              }
            });
  }
  function logout() {
    if (confirm("确定要退出系统吗？")) window.location.href = "/logout";
  }

  /* ---------- 页面加载 ---------- */
  document.addEventListener("DOMContentLoaded", () => {
    loadAllUsers();

    /* 选择文件后立即预览 */
    document.getElementById('avatarFile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const preview = document.getElementById('avatarPreview');
      preview.src = URL.createObjectURL(file); // 本地临时地址
      preview.onload = () => URL.revokeObjectURL(preview.src); // 释放内存
    });
  });
</script>
</body>
</html>